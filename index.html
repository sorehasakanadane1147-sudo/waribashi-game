<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ââ≤„ÇäÁÆ∏„ÉÅ„É£„É¨„É≥„Ç∏</title>

<style>
html,body{
  margin:0;height:100%;
  font-family:"Hiragino Mincho ProN","Yu Mincho",serif;
  background:#111;overflow:hidden;
}
#flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:100}

/* ===== „Çπ„Çø„Éº„Éà ===== */
#start{
  position:fixed;inset:0;
  background:linear-gradient(#f5f1e6,#e3d7bb);
  display:flex;flex-direction:column;
  justify-content:center;align-items:center;z-index:10;
}
.start-stick{
  width:20px;height:220px;
  background:repeating-linear-gradient(to bottom,#e6cfa3 0,#e6cfa3 4px,#d9b985 4px,#d9b985 8px);
  position:relative;margin-bottom:16px;
}
.start-stick::after{
  content:"";position:absolute;left:50%;
  width:2px;height:100%;background:#8c6a3f;transform:translateX(-50%);
}
.levels button{margin:6px;padding:10px 22px;background:#000;color:#fff;border:none}

/* ===== „Ç≤„Éº„É† ===== */
#game{
  display:none;height:100%;
  background:linear-gradient(#f7f3e8,#e4dac2);
  display:flex;flex-direction:column;
  align-items:center;padding-top:14px;
}
#chopstickArea{width:90px;height:260px;position:relative;margin:14px 0}
.stick,.half{
  width:18px;height:240px;
  position:absolute;left:50%;
  transform:translateX(-50%);
  background:repeating-linear-gradient(to bottom,#e6cfa3 0,#e6cfa3 4px,#d9b985 4px,#d9b985 8px);
}
.stick::after{
  content:"";position:absolute;left:50%;
  width:2px;height:100%;background:#8c6a3f;transform:translateX(-50%);
}
.jag-left{clip-path:polygon(100% 0,85% 6%,100% 14%,88% 22%,100% 30%,88% 38%,100% 46%,88% 54%,100% 62%,88% 70%,100% 78%,88% 86%,100% 94%,85% 100%,0 100%,0 0)}
.jag-right{clip-path:polygon(0 0,15% 6%,0 14%,12% 22%,0 30%,12% 38%,0 46%,12% 54%,0 62%,12% 70%,0 78%,12% 86%,0 94%,15% 100%,100% 100%,100% 0)}

#barWrap{width:96%;max-width:520px;height:14px;background:#aaa;border-radius:10px}
#bar{width:100%;height:100%;background:linear-gradient(to right,#999,#ffeb3b 46%,#ffeb3b 54%,#999);position:relative}
#cursor{position:absolute;top:-8px;width:4px;height:32px;background:#c62828}

button{margin-top:6px;padding:10px 22px;font-size:1em;border-radius:6px}
#splitBtn,#retryBtn{margin-top:12px;padding:16px 32px;font-size:1.2em}

#backBtn{position:fixed;top:12px;right:12px;z-index:50}

.gold{color:#d4af37;font-size:1.4em;animation:gold .5s ease}
@keyframes gold{from{transform:scale(1.4);opacity:0}to{transform:scale(1);opacity:1}}

#popup,#titleList{
  position:fixed;inset:0;
  display:none;align-items:center;justify-content:center;z-index:200;
}
#popup{background:rgba(0,0,0,.6)}
.popup-box{background:#fff;padding:20px 26px;border-radius:14px;text-align:center}
#titleList{background:#f7f3e8;flex-direction:column;overflow:auto}
.title-item{margin:6px;font-size:1.1em}
.locked{color:#999}
</style>
</head>

<body>
<div id="flash"></div>

<div id="popup">
  <div class="popup-box">
    <h2 id="popupText"></h2>
    <button onclick="closePopup()">OK</button>
  </div>
</div>

<div id="titleList">
  <h2>Áß∞Âè∑‰∏ÄË¶ß</h2>
  <div id="titleItems"></div>
  <button onclick="closeTitleList()">Êàª„Çã</button>
</div>

<div id="start">
  <div class="start-stick"></div>
  <h1>Ââ≤„ÇäÁÆ∏„ÉÅ„É£„É¨„É≥„Ç∏</h1>
  <div class="levels">
    <button onclick="startGame(1)">„Åã„Çì„Åü„Çì</button>
    <button onclick="startGame(2)">„Åµ„Å§„ÅÜ</button>
    <button onclick="startGame(3)">„ÇÄ„Åö„Åã„Åó„ÅÑ</button>
  </div>
  <button onclick="openTitleList()">Áß∞Âè∑‰∏ÄË¶ß</button>
</div>

<div id="game">
  <div id="chopstickArea"></div>
  <div id="barWrap"><div id="bar"><div id="cursor"></div></div></div>
  <button id="splitBtn" onclick="split()">Ââ≤„ÇãÔºÅ</button>
  <button id="retryBtn" onclick="retry()" style="display:none">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ââ≤„Çã</button>
  <div id="result"></div>
  <div id="score"></div>
  <button id="backBtn" onclick="backToStart()">„Çπ„Çø„Éº„Éà„Å∏Êàª„Çã</button>
</div>

<script>
let pos=0,dir=1,timer,speed=2,level=1;
let streak=[0,0,0];

const ALL_TITLES=[
 "Ââ≤„ÇäÁÆ∏„ÅÆË¶™Âèã","Ââ≤„ÇäÁÆ∏ËÅ∑‰∫∫","Chopstick Master",
 "Ââ≤„ÇäÁÆ∏„ÅÆË¶™Âèã üåà","Ââ≤„ÇäÁÆ∏ËÅ∑‰∫∫ üåà","Chopstick Master üåà",
 "Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ ÈäÖ","Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ ÈäÄ","Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ Èáë",
 "Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ üåà","Ââ≤„ÇäÁÆ∏„ÅÆÁ•û"
];

let titles=JSON.parse(localStorage.getItem("titles")||"{}");
ALL_TITLES.forEach(t=>{if(titles[t]===undefined)titles[t]=false});
save();

function save(){localStorage.setItem("titles",JSON.stringify(titles));}

function startGame(l){
  level=l;speed=l*1.6;
  start.style.display="none";
  game.style.display="flex";
  retry();
}

function backToStart(){
  clearInterval(timer);
  game.style.display="none";
  start.style.display="flex";
}

function moveBar(){
  clearInterval(timer);
  timer=setInterval(()=>{
    pos+=dir*speed;
    if(pos>100||pos<0)dir*=-1;
    cursor.style.left=pos+"%";
  },16);
}

function retry(){
  clearInterval(timer);
  chopstickArea.innerHTML='<div class="stick"></div>';
  result.innerHTML="";score.innerHTML="";
  splitBtn.style.display="inline";
  retryBtn.style.display="none";
  pos=0;dir=1;
  moveBar();
}

function flash(){
  flashEl.style.opacity=.9;
  setTimeout(()=>flashEl.style.opacity=0,120);
}

function split(){
  clearInterval(timer);
  splitBtn.style.display="none";
  retryBtn.style.display="inline";

  const diff=Math.abs(pos-50);
  let sc;

  if(level===2){
    sc = diff<=1.2 ? 100 : Math.max(0,100-Math.floor(diff*2));
  }else if(level===3){
    sc = diff<=1.3 ? 100 : Math.max(0,100-Math.floor(diff*2));
  }else{
    sc = Math.max(0,100-Math.floor(diff*2));
  }

  score.innerHTML=`„Çπ„Ç≥„Ç¢Ôºö${sc}ÁÇπ`;
  chopstickArea.innerHTML="";

  if(sc>=95){
    flash();
    result.innerHTML='<div class="gold">Â§ßÊàêÂäüÔºÅ</div>';
    perfect();
    streak[level-1]++;
    showStreak();
    checkTitles(sc);
  }else{
    streak[level-1]=0;
    result.innerHTML=sc>=70?"Â∞ë„ÅóÂ§±Êïó‚Ä¶":"Â§±Êïó‚Ä¶";
    sc>=70?slightFail():badFail();
  }
}

function perfect(){createHalf(-10);createHalf(10);}
function slightFail(){createHalf(-9,"left");createHalf(9,"right");}
function badFail(){createHalf(-6);}

function createHalf(x,side){
  const d=document.createElement("div");
  d.className="half"+(side?` jag-${side}`:"");
  d.style.transform=`translateX(-50%) translateX(${x}px)`;
  chopstickArea.appendChild(d);
}

function give(name){
  if(!titles[name]){
    titles[name]=true;save();
    popupText.innerHTML=`üéâ Áß∞Âè∑Áç≤ÂæóÔºÅ<br><strong>${name}</strong>`;
    popup.style.display="flex";
  }
}

function checkTitles(sc){
  const base=["Ââ≤„ÇäÁÆ∏„ÅÆË¶™Âèã","Ââ≤„ÇäÁÆ∏ËÅ∑‰∫∫","Chopstick Master"][level-1];
  if(sc>=95)give(base);
  if(streak[level-1]>=5)give(base+" üåà");
  if(sc===100)give("Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ "+["ÈäÖ","ÈäÄ","Èáë"][level-1]);
  if(titles["Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ ÈäÖ"]&&titles["Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ ÈäÄ"]&&titles["Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ Èáë"])
    give("Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ üåà");
  if(titles["Ââ≤„ÇäÁÆ∏„ÅÆË¶™Âèã üåà"]&&titles["Ââ≤„ÇäÁÆ∏ËÅ∑‰∫∫ üåà"]&&titles["Chopstick Master üåà"]&&titles["Ââ≤„ÇäÁÆ∏Ââ≤„Çä„ÅÆÈÅî‰∫∫ üåà"])
    give("Ââ≤„ÇäÁÆ∏„ÅÆÁ•û");
}

function openTitleList(){
  titleItems.innerHTML="";
  ALL_TITLES.forEach(t=>{
    titleItems.innerHTML+=`
      <div class="title-item ${titles[t]?"":"locked"}">
        ${titles[t]?t:"ÔºüÔºüÔºü"}
      </div>`;
  });
  titleList.style.display="flex";
}
function closeTitleList(){titleList.style.display="none";}
function closePopup(){popup.style.display="none";}

function showStreak(){
  const s=streak[level-1];
  if(s>=2){
    const d=document.createElement("div");
    d.className="gold";
    d.style.fontSize="1.1em";
    d.innerText=`${s}ÈÄ£Á∂öÊàêÂäüÔºÅ`;
    result.appendChild(d);
  }
}
</script>
</body>
</html>
