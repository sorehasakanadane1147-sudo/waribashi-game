<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‰²ã‚Šç®¸ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>

<style>
html,body{
  margin:0;height:100%;
  font-family:"Hiragino Mincho ProN","Yu Mincho",serif;
  background:#111;overflow:hidden;
}

/* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
#flash{
  position:fixed;inset:0;
  background:#fff;opacity:0;
  pointer-events:none;z-index:100;
}

/* ===== ã‚¹ã‚¿ãƒ¼ãƒˆ ===== */
#start{
  position:fixed;inset:0;
  background:linear-gradient(#f5f1e6,#e3d7bb);
  display:flex;flex-direction:column;
  justify-content:center;align-items:center;
  z-index:10;
}
.start-stick{
  width:20px;height:220px;
  background:repeating-linear-gradient(
    to bottom,#e6cfa3 0,#e6cfa3 4px,#d9b985 4px,#d9b985 8px);
  position:relative;margin-bottom:16px;
}
.start-stick::after{
  content:"";position:absolute;left:50%;
  width:2px;height:100%;
  background:#8c6a3f;transform:translateX(-50%);
}
.levels button{margin:6px;padding:10px 22px;background:#000;color:#fff;border:none}

/* ===== ã‚²ãƒ¼ãƒ  ===== */
#game{
  display:none;height:100%;
  background:linear-gradient(#f7f3e8,#e4dac2);
  display:flex;flex-direction:column;
  align-items:center;padding-top:14px;
}

#chopstickArea{
  width:90px;height:260px;
  position:relative;margin:14px 0;
}
.stick{
  width:18px;height:240px;
  position:absolute;left:50%;
  transform:translateX(-50%);
  background:repeating-linear-gradient(
    to bottom,#e6cfa3 0,#e6cfa3 4px,#d9b985 4px,#d9b985 8px);
}
.stick::after{
  content:"";position:absolute;left:50%;
  width:2px;height:100%;
  background:#8c6a3f;transform:translateX(-50%);
}

.half{
  position:absolute;
  background:repeating-linear-gradient(
    to bottom,#e6cfa3 0,#e6cfa3 4px,#d9b985 4px,#d9b985 8px);
}
.jag-left{clip-path:polygon(
  100% 0,85% 6%,100% 14%,88% 22%,100% 30%,88% 38%,
  100% 46%,88% 54%,100% 62%,88% 70%,100% 78%,88% 86%,
  100% 94%,85% 100%,0 100%,0 0);}
.jag-right{clip-path:polygon(
  0 0,15% 6%,0 14%,12% 22%,0 30%,12% 38%,
  0 46%,12% 54%,0 62%,12% 70%,0 78%,12% 86%,
  0 94%,15% 100%,100% 100%,100% 0);}

/* ãƒãƒ¼ */
#barWrap{width:96%;max-width:520px;height:14px;background:#aaa;border-radius:10px;}
#bar{width:100%;height:100%;background:linear-gradient(to right,#999,#ffeb3b 46%,#ffeb3b 54%,#999);position:relative;}
#cursor{position:absolute;top:-8px;width:4px;height:32px;background:#c62828;}

/* å…¨ä½“ãƒœã‚¿ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µã‚¤ã‚ºï¼ˆå°ã•ã‚ã«æˆ»ã™ï¼‰ */
button {
  margin-top: 6px;
  padding: 10px 22px;
  font-size: 1em;
  border-radius: 6px;
}

/* å‰²ã‚‹ãƒœã‚¿ãƒ³ãƒ»ã‚‚ã†ä¸€åº¦å‰²ã‚‹ãƒœã‚¿ãƒ³ã¯å¤§ãã‚ */
#splitBtn, #retryBtn {
  margin-top: 12px;
  padding: 16px 32px;
  font-size: 1.2em;
  border-radius: 8px;
}
/* ã‚¹ã‚¿ãƒ¼ãƒˆã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’å³ä¸Šã«å›ºå®š */
#backBtn{
  position:fixed;
  top:12px;
  right:12px;
  z-index:50;
}

.gold{
  color:#d4af37;font-size:1.4em;
  animation:gold .5s ease;
}
@keyframes gold{
  from{transform:scale(1.4);opacity:0}
  to{transform:scale(1);opacity:1}
}

/* ===== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ===== */
#popup{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;
  justify-content:center;z-index:200;
}
.popup-box{
  background:#fff;padding:20px 26px;
  border-radius:14px;text-align:center;
}

/* ===== ç§°å·ä¸€è¦§ ===== */
#titleList{
  position:fixed;inset:0;
  background:#f7f3e8;
  display:none;flex-direction:column;
  align-items:center;overflow:auto;z-index:150;
}
.title-item{margin:6px;font-size:1.1em}
.locked{color:#999}
</style>
</head>

<body>
<div id="flash"></div>

<div id="popup">
  <div class="popup-box">
    <h2 id="popupText"></h2>
    <button onclick="closePopup()">OK</button>
  </div>
</div>

<div id="titleList">
  <h2>ç§°å·ä¸€è¦§</h2>
  <div id="titleItems"></div>
  <button onclick="closeTitleList()">æˆ»ã‚‹</button>
</div>

<div id="start">
  <div class="start-stick"></div>
  <h1>å‰²ã‚Šç®¸ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
  <div class="levels">
    <button onclick="startGame(1)">ã‹ã‚“ãŸã‚“</button>
    <button onclick="startGame(2)">ãµã¤ã†</button>
    <button onclick="startGame(3)">ã‚€ãšã‹ã—ã„</button>
  </div>
  <button onclick="openTitleList()">ç§°å·ä¸€è¦§</button>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="game">
  <div id="chopstickArea"></div>
  <div id="barWrap"><div id="bar"><div id="cursor"></div></div></div>
  <button id="splitBtn" onclick="split()">å‰²ã‚‹ï¼</button>
  <button id="retryBtn" onclick="retry()" style="display:none">ã‚‚ã†ä¸€åº¦å‰²ã‚‹</button>
  <div id="result"></div>
  <div id="score"></div>
  <!-- ã‚²ãƒ¼ãƒ ç”»é¢å°‚ç”¨ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="backBtn" onclick="backToStart()" style="position:absolute;top:14px;right:14px;">ã‚¹ã‚¿ãƒ¼ãƒˆã¸æˆ»ã‚‹</button>
</div>

<script>
/* ===== çŠ¶æ…‹ ===== */
let pos=0,dir=1,timer,speed=2,level=1;
let streak=[0,0,0];

const ALL_TITLES=[
 "å‰²ã‚Šç®¸ã®è¦ªå‹","å‰²ã‚Šç®¸è·äºº","Chopstick Master",
 "å‰²ã‚Šç®¸ã®è¦ªå‹ ğŸŒˆ","å‰²ã‚Šç®¸è·äºº ğŸŒˆ","Chopstick Master ğŸŒˆ",
 "å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº éŠ…","å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº éŠ€","å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº é‡‘",
 "å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº ğŸŒˆ","å‰²ã‚Šç®¸ã®ç¥"
  // æ–°ç§°å·
 "å‰²ã‚Šç®¸ã‚’æ¥µã‚ã—è€… éŠ…","å‰²ã‚Šç®¸ã‚’æ¥µã‚ã—è€… éŠ€","å‰²ã‚Šç®¸ã‚’æ¥µã‚ã—è€… é‡‘"
];

let titles=JSON.parse(localStorage.getItem("titles")||"{}");
ALL_TITLES.forEach(t=>{if(titles[t]===undefined)titles[t]=false});
save();

function save(){localStorage.setItem("titles",JSON.stringify(titles));}

/* ===== ç”»é¢ ===== */
const backBtn = document.getElementById("backBtn");
backBtn.style.display = "none"; // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¯éè¡¨ç¤º
function startGame(l){
  level=l; speed=l*1.6;
  start.style.display="none";
  game.style.display="flex";
  backBtn.style.display = "inline"; // ã‚²ãƒ¼ãƒ ç”»é¢ã«ãªã£ãŸã‚‰è¡¨ç¤º
  retry();
}

function backToStart(){
  clearInterval(timer);
  game.style.display="none";
  start.style.display="flex";
  backBtn.style.display="none"; // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã£ãŸã‚‰éè¡¨ç¤º
}

/* ===== ãƒãƒ¼ ===== */
function moveBar(){
  clearInterval(timer);
  timer=setInterval(()=>{
    pos+=dir*speed;
    if(pos>100||pos<0)dir*=-1;
    cursor.style.left=pos+"%";
  },16);
}

/* ===== ãƒªãƒˆãƒ©ã‚¤ ===== */
function retry(){
  clearInterval(timer);
  chopstickArea.innerHTML='<div class="stick"></div>';
  result.innerHTML="";score.innerHTML="";
  splitBtn.style.display="inline";
  retryBtn.style.display="none";
  pos=0;dir=1;
  moveBar();
}

/* ===== ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ ===== */
const flashEl = document.getElementById("flash");
function flash(){
  flashEl.style.opacity=.9;
  setTimeout(()=>flashEl.style.opacity=0,120);
}

// ===== å‰²ã‚‹ =====
function split(){
  clearInterval(timer);
  splitBtn.style.display="none";
  retryBtn.style.display="inline";

  const diff = Math.abs(pos-50);
  let sc;

 if(level===2){      // ãµã¤ã†
  sc = (diff <= 1.3) ? 100 : Math.max(0,100-Math.floor(diff*2));
}else if(level===3){ // ã‚€ãšã‹ã—ã„
  sc = (diff <= 1.2) ? 100 : Math.max(0,100-Math.floor(diff*2));
}else{               // ã‹ã‚“ãŸã‚“
    sc = Math.max(0,100-Math.floor(diff*2));
  }

  score.innerHTML = `ã‚¹ã‚³ã‚¢ï¼š${sc}ç‚¹`;

  chopstickArea.innerHTML="";

  if(sc>=95){
    flash();
    result.innerHTML='<div class="gold">å¤§æˆåŠŸï¼</div>';
    perfect();

    streak[level-1]++;
    showStreak();
    checkTitles(sc);
  }else{
    streak[level-1]=0;
    if(sc>=70){
      result.innerHTML="å°‘ã—å¤±æ•—â€¦";
      slightFail();
    }else{
      result.innerHTML="å¤±æ•—â€¦";
      badFail();
    }
  }
}

/* ===== å‰²ã‚Œæ–¹ ===== */
function perfect(){createHalf(-10,false);createHalf(10,false);}
function slightFail(){createHalf(-9,true,"left");createHalf(9,true,"right");}
function badFail(){
  createHalf(-6,false);
  const u=document.createElement("div");
  u.className="half";u.style.width="9px";u.style.height="120px";u.style.left="52%";
  chopstickArea.appendChild(u);
  const l=document.createElement("div");
  l.className="half jag-right";l.style.width="9px";l.style.height="120px";
  l.style.top="120px";l.style.left="56%";l.style.transform="rotate(24deg)";
  chopstickArea.appendChild(l);
}
function createHalf(x,jag,side){
  const d=document.createElement("div");
  d.className="half"+(jag?` jag-${side}`:"");
  d.style.width="9px";d.style.height="240px";d.style.left="50%";
  d.style.transform=`translateX(-50%) translateX(${x}px)`;
  chopstickArea.appendChild(d);
}

/* ===== ç§°å· ===== */
function give(name){
  if(!titles[name]){
    titles[name]=true;save();
    popupText.innerHTML = `ğŸ‰ ç§°å·ç²å¾—ï¼<br><strong>${name}</strong>`;
    popup.style.display="flex";
  }
}
function checkTitles(sc){
  const base=["å‰²ã‚Šç®¸ã®è¦ªå‹","å‰²ã‚Šç®¸è·äºº","Chopstick Master"][level-1];
  if(sc>=95)give(base);
  if(streak[level-1]>=5)give(base+" ğŸŒˆ");
  if(sc===100)give("å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº "+["éŠ…","éŠ€","é‡‘"][level-1]);
  if(titles["å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº éŠ…"]&&titles["å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº éŠ€"]&&titles["å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº é‡‘"])
    give("å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº ğŸŒˆ");
  if(titles["å‰²ã‚Šç®¸ã®è¦ªå‹ ğŸŒˆ"]&&titles["å‰²ã‚Šç®¸è·äºº ğŸŒˆ"]&&titles["Chopstick Master ğŸŒˆ"]&&titles["å‰²ã‚Šç®¸å‰²ã‚Šã®é”äºº ğŸŒˆ"])
    give("å‰²ã‚Šç®¸ã®ç¥");
  if(streak[level-1] >= 11){
  const newTitle = "å‰²ã‚Šç®¸ã‚’æ¥µã‚ã—è€… " + ["éŠ…","éŠ€","é‡‘"][level-1];
  give(newTitle);
}

/* ===== UI ===== */
function closePopup(){popup.style.display="none";}
function openTitleList(){
  titleItems.innerHTML="";
  ALL_TITLES.forEach(t=>{
    titleItems.innerHTML+=`<div class="title-item ${titles[t]?"":"locked"}">
      ${titles[t]?t:"ï¼Ÿï¼Ÿï¼Ÿ"}
    </div>`;
  });
  titleList.style.display="flex";
}
function closeTitleList(){titleList.style.display="none";}

function showStreak(){
  const s = streak[level-1];
  if(s >= 2){
    const div = document.createElement("div");
    div.className = "gold";
    div.style.fontSize = "1.1em";
    div.innerText = `${s}é€£ç¶šæˆåŠŸï¼`;
    result.appendChild(div);
  }
}
</script>
</body>
</html>
